# Техническое задание: локальная система генерации фотореалистичных портретов

## 1. Цель и задачи
1. Создать локальную генеративную систему, способную по текстовому описанию с уникальным триггер-токеном выдавать серию фотореалистичных изображений конкретного человека без заметной потери внешнего сходства.
2. Обеспечить работу на одной видеокарте RTX 5060 Ti 16 GB без обращения к облачной инфраструктуре.
3. Реализовать два режима инференса: «быстрый» (по триггеру + LoRA) и «надёжный» (с подключением референс-адаптера и/или ветки Image-Edit для сложных сцен).

## 2. Основание и ограничения
- Базовая модель: Qwen-Image 20B в облегчённом формате весов (FP8/Q4 смешанные квантизации) для экономии VRAM; вместе с ней поставляются соответствующий текстовый энкодер, VAE и tokenizer.json, использованные при обучении LoRA.
- Идентичность человека не модифицирует базовую модель — создаётся индивидуальная LoRA-надстройка.
- Условия эксплуатации: полностью офлайн, без передачи данных третьим лицам; соблюдение прав на образ человека обязательно.

## 3. Управление триггер-токеном персоны
1. Для каждой персоны резервируется уникальный редкий токен (например, `<qwn_alex>`), которого нет в словаре модели.
2. Токен добавляется в токенайзер текстового энкодера с инициализацией эмбеддинга от близкого по смыслу слова («person», «portrait»).
3. Проверяется целостность токена: он не должен разбиваться на подстроки и не должен совпадать с другими пользовательскими токенами; при невозможности расширить словарь допускается выбор крайне редкой существующей лексемы, подтверждённой тестом в токенайзере.
4. Токен фиксируется в датасете (все подписи содержат его явным образом) и в промт-шаблонах инференса.
5. Namespaces: каждый токен и каталог данных имеет префикс персоны; одновременная загрузка двух разных LoRA запрещена.
6. При поставке модели в ComfyUI обязательно предоставляется tokenizer.json из обучения LoRA, либо preset, указывающий допустимую «готовую» лексему.
7. Runtime-check: при старте графа выполняется прогон триггер-токена через используемый tokenizer с логированием ID-последовательности; если токен распался на две и более частей (например, после обновления нод), выполнение останавливается с подсказкой подключить упаковку tokenizer из набора обучения.

## 4. Функциональные требования
1. **Генерация по тексту**: ввод промта с уникальным токеном и описанием сцены приводит к выдаче 4–8 изображений с высоким сходством.
2. **Режим надёжности**: по требованию пользователь подключает эталонное фото через FaceID/IP-Adapter и/или позный контроллер, чтобы зафиксировать черты лица и позу.
3. **Редактирование**: поддержка ветки Image-Edit для вставки лица в существующий кадр и дорисовки окружения.
4. **Управление параметрами**: возможность задавать коэффициент LoRA, CFG, число шагов, разрешение кадра (по умолчанию 768 px по короткой стороне).
5. **Пресеты**: два готовых профиля (быстрый и надёжный) с сохранёнными настройками и seed.
6. **Мультиперсона**: хранение нескольких LoRA и токенов в независимых каталогах с выбором активной персоны перед запуском.

## 5. Нефункциональные требования
- Среднее время генерации одного кадра в «быстром» режиме — не более 60 секунд при 30–50 шагах сэмплирования.
- Качество сходства измеряется face-ID моделью; порог определяется по ROC на валидационном сплите при целевом FPR 1%.
- Интерфейс запуска — CLI/скриптовый слой + готовность интеграции в ComfyUI (узлы для загрузки токена, LoRA, FaceID/IP-Adapter).
- Логи обучений и инференса хранятся локально не менее 30 дней.
- Контроль воспроизводимости: фиксируется seed, версии весов и библиотек, а также доступный объём VRAM на момент прогона.

## 6. Архитектура решения
1. **Слои данных**: каталог датасетов пользователя + каталог эталонных фото (с очищенными EXIF).
2. **Модельные артефакты**: Qwen-Image 20B (веса UNet/MMDiT), связанный текстовый энкодер, VAE и tokenizer; поставляются единым пакетом и версионируются. Любой редкий токен либо присутствует в пакете tokenizer, либо документирован выбор существующей лексемы.
3. **LoRA-таргеты**: кросс-аттеншены U-Net (основные) и верхние слои текстового энкодера; по умолчанию обучаются оба набора. Конфигурация фиксируется в манифесте персоны.
4. **Сервис обучения**: скрипт fine-tune LoRA с градиент-чекпоинтингом, mixed precision (bf16/fp16) и аккумуляцией градиентов.
5. **Сервис инференса**: пайплайн, который принимает промт, конфигурацию режима, подключает нужные веса и возвращает изображения (CLI + ComfyUI-нод).
6. **ComfyUI-графы**: пресеты содержат узлы загрузки базовой модели/текстового энкодера/VAE/tokenizer, ноду подключения LoRA, FaceID/IP-Adapter, Pose/Depth ControlNet и ветку Image-Edit с маской.
7. **Контур контроля качества**: скрипт измерения схожести по батчу тестовых промтов и референсов, выдающий метрики и рекомендации (усилить LoRA, включить референс и т.п.).
8. **Управление VRAM**: мониторинг потребления; при нехватке памяти происходит деградация (понижение разрешения/шагов), а не аварийный останов.

## 7. Требования к данным
1. Размер выборки для одного человека: 40–80 уникальных фото; допустимо меньше при высокой вариативности.
2. Покрытие: фронтальные кадры, 3/4, несколько профилей, различные эмоции, освещения, 2–3 полноформатных кадра (по пояс и полный рост).
3. Качество: отсутствие тяжёлых фильтров, ретуши, карикатурных перспектив; разрешение приводится к 768 px по короткой стороне.
4. Подготовка: выравнивание по лицу, удаление дублей и серий, разбавление постоянных аксессуаров альтернативами; данные раскладываются по «бакетам» разных соотношений сторон (напр. 1:1, 3:4, 2:3, 9:16) с мульти-резолюцией, чтобы исключить деформации при тренировке.
5. Разметка: уникальный токен + базовые дескрипторы (пол, возраст, цвет волос, сцена) без художественных стилей.
6. Аугментации: допустимы лёгкие color-jitter, шум, кропы, пространственные сдвиги; горизонтальные флипы запрещены, если есть выраженная асимметрия (родинка, пробор).
7. Безопасность: EXIF/геоданные очищаются, каталоги референсов шифруются или ограничиваются ACL.
8. Негативные примеры: несколько десятков контрастных описаний/кадров без токена.
9. Стресс-набор: 10–20 кадров с окклюзиями (очки, шарфы, рука у лица), экстремальным светом и дальними планами для контроля поведения в «диких» сценах.
10. Класс-регуляризация: 200–400 нейтральных портретов («обычный человек») в духе DreamBooth.

## 8. Процесс обучения LoRA
1. Аппарат: RTX 5060 Ti 16 GB, градиент-чекпоинтинг, mixed precision (bf16 предпочтительно), аккумуляция до эффективного батча 4.
2. Настройки: разрешение 768 px, ранг LoRA 16–32, 2 000–4 000 шагов (ранняя остановка по валидации), learning rate 5e-5–1e-4.
3. Dtype-совместимость: LoRA и адаптеры обучаются в fp16/bf16, при инференсе автоматически приводятся к dtype базовой модели (FP8/FP16) в соответствующих нодах ComfyUI/CLI перед мёрджем; для финальных рендеров допускается переключение всей цепочки на FP16/Q8 без изменения графа.
4. Временные показатели: 1–2 часа на полный прогон с учётом регуляризации.
5. Выходные артефакты: файл весов LoRA, JSON-манифест (токен, ранг, таргеты, дата), контрольные сгенерированные кадры.
6. Автотест: после обучения запускается скрипт генерации 10–20 тестовых промтов + эталонные пары; результаты сохраняются для построения ROC и обновления порога.

## 9. Режимы инференса
1. **Быстрый режим**  
   - Обязательный триггер-токен в промте.  
   - LoRA подключена с коэффициентом 0.6–0.9.  
   - CFG 6–8, 30–50 шагов, sampler Euler/Euler a.  
   - Выход: батч 4–8 кадров 768 px.
2. **Надёжный режим (иерархия действий)**  
   - Шаг 1: узел FaceID/IP-Adapter повышает вес до 0.5–0.7 и применяется регионально к маске лица (через встроенную поддержку ноды либо отдельную ветку с блендингом), параллельно активируется pose/depth ControlNet с замороженными seed и sampler.  
   - Шаг 2: увеличивается разрешение до 1024 px и длина прохода до 50–70 шагов в тех же sampler/seed; изменения фиксируются в графе и JSON-экспорте.  
   - Шаг 3: при недостижении порога в граф включается ветка Image-Edit с маской лица (узлы Mask/Refiner), куда подаётся эталон и промт окружения.  
   - Все шаги логируются и могут включаться автоматически по сигналу метрики.
3. **Редактирование**  
   - Маскирование области лица на исходном кадре.  
   - Инъекция лица из референса + дорисовка окружения текстовым описанием.  
   - Сохранение карты прозрачности и масок для повторных правок.
4. **Fallback по ресурсам**  
   - При нехватке VRAM система автоматически снижает батч/разрешение/число шагов и уведомляет оператора; в ComfyUI это оформлено отдельной веткой с переключателем профиля.

## 10. Контроль качества и автоматизация
1. Метрика: косинусная близость эмбеддингов face-ID между сгенерированным кадром и эталоном; используется та же face-ID модель и препроцессинг, что и в FaceID/IP-Adapter (единый стек).
2. Калибровка: формируется валидационный сплит из позитивных/негативных пар, включая stress-набор с окклюзиями, строится ROC, выбирается порог при FPR 1%. Целевой критерий приёмки: TPR ≥ 90% на stress-наборе при указанном пороге; если условие не выполняется, автоматически активируется «надёжный» профиль либо инициируется досбор данных/переобучение.
3. Автопереключатель: если средняя метрика батча ниже порога, ComfyUI-пресет отправляет сигнал в управляющий скрипт, который переводит граф в надёжный профиль; если и после усилений метрика ниже FNR-порога, выдаётся флаг на досбор данных/переобучение.
4. Логи: для каждой генерации сохраняется промт, seed, sampler, режим, коэффициенты, dtype, использование референсов, сохранённый graph.json и значение метрики; гриды и превью складываются в единый каталог.
5. Скрипт отчётности: ежедневный отчёт по средним метрикам, числу переключений режимов и статусу критерия (TPR при FPR=1%).

## 11. Инфраструктура, стек и интеграция
- ОС: Windows 11 / WSL2 с CUDA 12.x.
- Язык и бэкенд: Python 3.10+, PyTorch 2.x, diffusers/transformers с поддержкой Qwen-Image.
- Ускорения: xFormers, Flash-Attention (при совместимости), библиотеки ControlNet/IP-Adapter.
- Хранилище: локальный SSD ≥ 200 ГБ для датасетов, чекпоинтов и логов.
- Интеграция с ComfyUI: набор нодов для загрузки базовой модели, текстового энкодера, VAE и tokenizer, LoRA, FaceID/IP-Adapter, Pose/Depth ControlNet, ветки Image-Edit, а также управляющий узел, принимающий сигнал метрики и переключающий пресеты.
- FaceID/IP-Adapter-нода должна поддерживать применение к маске лица (через встроенную опцию или отдельную ветку с блендингом), чтобы вес адаптера не влиял на фон/волосы.
- Preset-наборы: для каждого режима хранится graph.json с фиксированными seed, sampler, шагами, dtype и настройками узлов; при экспорте автоматически сохраняются гриды итогов.
- Face-restoration/beauty-ноды (GFPGAN, CodeFormer и аналоги) по умолчанию отключены в пресетах; их включение допустимо только после успешной проверки метрики, с силой ≤0.2 и исключительно как постобработку.
- Управление зависимостями: poetry/conda env с lock-файлом; каждая сборка фиксирует версии библиотек и CUDA.

## 12. Эксплуатация и безопасность
1. **Промт-дисциплина**: уникальный токен обязателен, художественные стили подключаются только сознательно.
2. **Версионирование**: каждую итерацию LoRA сохранять с описанием датасета, параметров и датой; запрещено одновременное использование двух LoRA разных людей.
3. **Правовые аспекты**: хранить согласия субъектов данных, ограничить доступ к выборкам и референсам, деперсонализировать метаданные.
4. **Этические ограничения**: запрет на сценарии, которые могут трактоваться как дипфейки без явного разрешения.
5. **Воспроизводимость**: фиксировать seed, указатели на веса и конфиги; при падении VRAM переходить к заранее определённому degraded-профилю вместо аварийной остановки.

## 13. План внедрения и риски
1. **Этап 1 — Подготовка данных (1 неделя)**: сбор и чистка фото, разметка токенов, подготовка регуляризационного набора, очистка EXIF.
2. **Этап 2 — Настройка окружения (0.5 недели)**: установка зависимостей, проверка GPU, скачивание базовых весов, настройка ComfyUI.
3. **Этап 3 — Обучение и валидация (1 неделя)**: запуск LoRA, построение ROC, корректировки.
4. **Этап 4 — Инференс-пайплайн (0.5 недели)**: реализация режимов, автопереключателя, fallback по VRAM и логирования.
5. **Этап 5 — Документация и передача (0.5 недели)**: инструкции по эксплуатации, шаблоны промтов, схемы ComfyUI.

Основные риски: недостаточная вариативность данных (решается досбором и регуляризацией), деградация сходства на сложных сценах (иерархия надёжного режима), юридические претензии (формальное согласие и приватное хранение), несоответствие токена (миграция токенайзера между версиями модели).
